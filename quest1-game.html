<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>The Coding Chamber</title>
    <link rel="stylesheet" href="quest-style.css">

    <style>
        .hud {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin: 10px 0 18px;
        }

        .task-chip {
            font-weight: 800;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.08);
        }

        .progress-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-text {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.15);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.12);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #16a34a, #22c55e);
        }

        .console-box {
            background: #070b07;
            color: #b9ffb9;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
                "Courier New", monospace;
            padding: 16px;
            border-radius: 14px;
            text-align: left;
            margin-top: 14px;
            border: 1px solid rgba(34, 197, 94, 0.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .console-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
        }

        .dot.red {
            background: #ff5f56;
        }

        .dot.yellow {
            background: #ffbd2e;
        }

        .dot.green {
            background: #27c93f;
        }

        .console-title {
            font-size: 13px;
            color: rgba(185, 255, 185, 0.75);
            font-weight: 700;
        }

        .console-history {
            min-height: 140px;
            max-height: 220px;
            overflow-y: auto;
            padding: 10px 10px 0 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(34, 197, 94, 0.15);
        }

        .line {
            margin: 0 0 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .prompt {
            color: #5eead4;
            font-weight: 700;
        }

        .usercode {
            color: #e2ffe2;
        }

        .ok {
            color: #22c55e;
            font-weight: 700;
        }

        .err {
            color: #fb7185;
            font-weight: 700;
        }

        .output {
            color: rgba(185, 255, 185, 0.9);
            margin-left: 8px;
        }

        .console-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px 2px;
            margin-top: 10px;
        }

        #codeInput {
            background: transparent;
            border: none;
            color: #e2ffe2;
            outline: none;
            width: 100%;
            font-size: 16px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .game-btn {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 800;
            transition: transform 0.08s ease, opacity 0.2s ease;
        }

        .game-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #22c55e;
            color: #052e12;
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.12);
            color: #111827;
        }

        .btn-ghost {
            background: transparent;
            color: rgba(0, 0, 0, 0.65);
            text-decoration: underline;
        }

        /* Mobile */
        @media (max-width: 700px) {
            .hud {
                flex-direction: column;
                align-items: stretch;
            }

            .task-chip {
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="parchment">
        <h1 style="margin-bottom:8px;">The Coding Chamber</h1>

        <!-- HUD -->
        <div class="hud">
            <div class="task-chip" id="taskChip">Task 1</div>

            <div class="progress-wrap">
                <div class="progress-text">
                    <span id="progressText">Progress: 0%</span>
                    <span id="taskCount">1 / 10</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <!-- Instruction -->
        <p id="taskInstr" style="font-size:18px; font-weight:700;">Loading...</p>

        <!-- Console -->
        <div class="console-box">
            <div class="console-top">
                <div class="dots">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <div class="console-title">python_chamber.exe</div>
            </div>

            <div class="console-history" id="history">
                <p class="line"><span class="ok">Welcome, Coder.</span> Type the spell and press Enter ‚ö°</p>
            </div>

            <div class="console-input">
                <span class="prompt">>>> </span>
                <input type="text" id="codeInput" placeholder="Type code here..." autocomplete="off" />
            </div>
        </div>

        <!-- Feedback / Buttons -->
        <p id="feedback" style="margin-top:14px; font-weight:900;"></p>

        <div class="btn-row">
            <button class="game-btn btn-primary" id="nextBtn" style="display:none;">Next Task ‚ûú</button>
            <button class="game-btn btn-secondary" id="retryBtn">Retry</button>
            <button class="game-btn btn-ghost" id="resetBtn">Reset Quest</button>
        </div>
    </div>

    <script>

        let currentTask = localStorage.getItem('qTask') ? parseInt(localStorage.getItem('qTask')) : 0;

        const tasks = [
            { instr: 'Type: <code>print("Hello Python")</code>', target: 'print("Hello Python")', output: 'Hello Python' },
            { instr: 'Print the number <code>2026</code>', target: 'print(2026)', output: '2026' },
            { instr: 'Calculate <code>5 + 5</code>', target: 'print(5+5)', output: '10' },
            { instr: 'Multiply <code>10</code> by <code>2</code>', target: 'print(10*2)', output: '20' },
            { instr: 'Write a comment: <code># magic</code>', target: '# magic', output: '(comment saved)' },
            { instr: 'Join <code>"Fire" + "Ball"</code>', target: 'print("Fire"+"Ball")', output: 'FireBall' },
            { instr: 'Print <code>1, 2, 3</code>', target: 'print(1,2,3)', output: '1 2 3' },
            { instr: 'Print <code>"Success"</code>', target: 'print("Success")', output: 'Success' },
            { instr: 'Type: <code>print("Python")</code>', target: 'print("Python")', output: 'Python' },
            { instr: 'Type: <code># finished</code>', target: '# finished', output: '(quest flag raised)' }
        ];

        /* Elements*/
        const taskChip = document.getElementById("taskChip");
        const taskInstr = document.getElementById("taskInstr");
        const feedback = document.getElementById("feedback");
        const history = document.getElementById("history");
        const input = document.getElementById("codeInput");

        const progressText = document.getElementById("progressText");
        const taskCount = document.getElementById("taskCount");
        const progressFill = document.getElementById("progressFill");

        const nextBtn = document.getElementById("nextBtn");
        const retryBtn = document.getElementById("retryBtn");
        const resetBtn = document.getElementById("resetBtn");

        /* Helpers */
        function normalize(s) { return s.replace(/\s+/g, '').trim(); }

        function addLine(html) {
            const p = document.createElement("p");
            p.className = "line";
            p.innerHTML = html;
            history.appendChild(p);
            history.scrollTop = history.scrollHeight;
        }

        function updateHUD() {
            if (currentTask < 0) currentTask = 0;
            if (currentTask > tasks.length) currentTask = tasks.length;

            const percent = Math.round((currentTask / tasks.length) * 100);

            taskChip.innerText = `Task ${Math.min(currentTask + 1, tasks.length)}`;
            taskInstr.innerHTML = tasks[currentTask]?.instr || "Quest Completed!";

            progressText.innerText = `Progress: ${percent}%`;
            taskCount.innerText = `${Math.min(currentTask + 1, tasks.length)} / ${tasks.length}`;
            progressFill.style.width = `${percent}%`;
        }

        function completeQuest() {
            feedback.style.color = "#16a34a";
            feedback.innerHTML = "üèÜ Quest 1 Complete! Returning to map...";
            addLine(`<span class="ok">Quest Completed.</span>`);

            localStorage.setItem("q1Complete", "1");
            localStorage.setItem("qTask", tasks.length);

            nextBtn.style.display = "none";

            setTimeout(() => location.href = "python-level.html", 1300);
        }

        function loadTask() {
            if (currentTask >= tasks.length) {
                completeQuest();
                return;
            }
            updateHUD();
            feedback.innerHTML = "";
            nextBtn.style.display = "none";
            input.value = "";
            input.focus();
        }

        function successFlow() {
            feedback.style.color = "#16a34a";
            feedback.innerHTML = "‚ú® Spell Successful! Click Next Task.";
            nextBtn.style.display = "inline-block";
        }

        function failFlow() {
            feedback.style.color = "#fb7185";
            feedback.innerHTML = "‚ùå The magic failed. Check your quotes and brackets!";
        }

        /* Main Game logic*/
        function runSpell() {
            if (currentTask >= tasks.length) {
                completeQuest();
                return;
            }

            const userInput = input.value.trim();
            if (!userInput) return;

            addLine(`<span class="prompt">>>> </span><span class="usercode">${userInput.replaceAll("<", "&lt;")}</span>`);

            const cleanInput = normalize(userInput);
            const cleanTarget = normalize(tasks[currentTask].target);

            if (cleanInput === cleanTarget) {
                addLine(`<span class="ok">‚úì Spell Successful</span><span class="output"> ${tasks[currentTask].output}</span>`);
                successFlow();

                currentTask++;
                localStorage.setItem('qTask', currentTask);

                // if that was last task -> finish immediately
                if (currentTask >= tasks.length) {
                    completeQuest();
                    return;
                }
            } else {
                addLine(`<span class="err">‚úó Error</span><span class="output"> Try again</span>`);
                failFlow();
            }
        }

        /* Events */
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") runSpell();
        });

        nextBtn.addEventListener("click", () => {
            // go to info page for next lesson
            location.href = "q1info.html";
        });

        retryBtn.addEventListener("click", () => {
            input.value = "";
            feedback.innerHTML = "";
            input.focus();
            addLine(`<span class="ok">-- retry --</span>`);
        });

        resetBtn.addEventListener("click", () => {
            localStorage.setItem('qTask', 0);
            localStorage.removeItem("q1Complete");
            currentTask = 0;
            history.innerHTML = `<p class="line"><span class="ok">Quest reset.</span> Start again ‚ö°</p>`;
            loadTask();
        });

        window.onload = loadTask;
    </script>

</body>

</html>