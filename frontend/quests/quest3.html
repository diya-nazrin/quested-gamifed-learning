<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Level 3: The Automated Alchemist</title>
    <link rel="stylesheet" href="quest-style.css">

    <style>
        .cauldron-area {
            text-align: center;
            margin: 22px 0;
        }

        /* ===== BELT WRAP ===== */
        .belt-wrap {
            background: #2c1808;
            border: 4px solid #f1c40f;
            border-radius: 12px;
            padding: 16px;
            overflow: hidden;
            position: relative;
            margin-top: 18px;
        }

        .belt {
            display: flex;
            gap: 16px;
            width: max-content;
            animation: moveBelt 7s linear infinite;
            align-items: center;
        }

        @keyframes moveBelt {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-50%);
            }
        }

        .belt.paused {
            animation-play-state: paused;
        }

        .item {
            padding: 14px 16px;
            background: #f4e4bc;
            border: 2px solid #3e2712;
            border-radius: 12px;
            font-weight: 900;
            min-width: 88px;
            text-align: center;
            transition: transform 0.25s, box-shadow 0.25s, background 0.25s;
            user-select: none;
        }

        .active-item {
            transform: scale(1.12);
            border-color: #f1c40f;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.85);
        }

        .code-display {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
            border-radius: 10px;
            margin: 18px 0;
            text-align: left;
            border: 1px solid rgba(34, 197, 94, 0.35);
        }

        /* HUD progress */
        .hud {
            margin-top: 12px;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-weight: 900;
            margin-bottom: 8px;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        .progress-bar {
            height: 12px;
            width: 100%;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.15);
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.12);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.25s ease;
            background: linear-gradient(90deg, #16a34a, #22c55e);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .btn-small {
            padding: 10px 16px;
            font-weight: 900;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: transform 0.08s ease, opacity 0.15s ease;
        }

        .btn-small:active {
            transform: scale(0.98);
        }

        .transmute {
            background: #f1c40f;
            color: #2c1808;
        }

        .skip {
            background: #3e2712;
            color: #f4e4bc;
        }

        .step {
            background: #8e44ad;
            color: #fff;
        }

        .next {
            background: #27ae60;
            color: white;
            display: none;
        }

        .inventory-view {
            margin-top: 14px;
            background: rgba(0, 0, 0, 0.08);
            padding: 12px 14px;
            border-radius: 10px;
            text-align: left;
            font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
            font-weight: 800;
            overflow-x: auto;
        }

        #feedback {
            margin-top: 14px;
            font-weight: 900;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="parchment">
        <h2>Quest: The Loop of Transmutation</h2>
        <p>Step through the loop. Only <b>"Lead"</b> should become <b>"Gold"</b>.</p>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-top">
                <span id="exerciseText">Exercise: 1 / 3</span>
                <span id="stepText">Step: 0 / 0</span>
                <span>Rule: Lead ‚Üí Gold ‚ú®</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- code -->
        <div class="code-display">
            for i in range(len(inventory)):
            if inventory[i] == "Lead":
            inventory[i] = "Gold"
        </div>

        <!-- MOVING BELT -->
        <div class="belt-wrap">
            <div class="belt" id="belt"></div>
        </div>

        <div class="inventory-view">
            inventory = <span id="invText">[]</span>
        </div>

        <div class="cauldron-area">
            <div class="btn-row">
                <button class="btn-small step" onclick="nextIteration()">Next Iteration</button>
                <button class="btn-small transmute" onclick="playerAction(true)">Transmute</button>
                <button class="btn-small skip" onclick="playerAction(false)">Skip</button>

                <!-- appears after each exercise complete -->
                <button class="btn-small next" id="nextExerciseBtn" onclick="startNextExercise()">Next Exercise
                    ‚ûú</button>
            </div>

            <p style="opacity:0.85; margin-top:10px; font-weight:800;">
                Tip: Transmute only when the item is <b>Lead</b>.
            </p>
        </div>

        <p id="feedback"></p>
    </div>

    <script>
        // ‚úÖ 3 Exercises (you can add/remove easily)
        const EXERCISES = [
            ["Herb", "Lead", "Herb", "Lead"],                          // Easy
            ["Lead", "Herb", "Herb", "Lead", "Herb", "Lead"],          // Medium
            ["Herb", "Lead", "Lead", "Herb", "Lead", "Herb", "Lead", "Herb"] // Hard
        ];

        let exerciseIndex = 0;
        let currentIndex = 0;

        let items = [];       // current exercise inventory
        let beltItems = [];   // duplicated for endless motion

        const belt = document.getElementById("belt");
        const feedback = document.getElementById("feedback");
        const invText = document.getElementById("invText");

        const exerciseText = document.getElementById("exerciseText");
        const stepText = document.getElementById("stepText");
        const progressFill = document.getElementById("progressFill");
        const nextExerciseBtn = document.getElementById("nextExerciseBtn");

        let domBeltItems = [];

        function pauseBelt(ms = 650) {
            belt.classList.add("paused");
            setTimeout(() => belt.classList.remove("paused"), ms);
        }

        function buildBelt() {
            belt.innerHTML = "";
            domBeltItems = [];

            beltItems.forEach((it) => {
                const div = document.createElement("div");
                div.className = "item";
                div.innerText = it;
                belt.appendChild(div);
                domBeltItems.push(div);
            });

            updateInventoryText();
            updateHUD();
            highlightCurrent();

            feedback.style.color = "#333";
            feedback.innerText = "Press Next Iteration to begin ‚öôÔ∏è";
        }

        function updateInventoryText() {
            invText.innerText = JSON.stringify(items);
        }

        function updateHUD() {
            exerciseText.innerText = `Exercise: ${exerciseIndex + 1} / ${EXERCISES.length}`;
            stepText.innerText = `Step: ${Math.min(currentIndex, items.length)} / ${items.length}`;
            const percent = Math.round((Math.min(currentIndex, items.length) / items.length) * 100);
            progressFill.style.width = percent + "%";
        }

        function highlightCurrent() {
            domBeltItems.forEach(el => el.classList.remove("active-item"));

            if (currentIndex < items.length) {
                // highlight first occurrence of current item in belt
                domBeltItems[currentIndex].classList.add("active-item");
            }
        }

        function loadExercise(index) {
            exerciseIndex = index;
            currentIndex = 0;

            items = [...EXERCISES[index]];
            beltItems = [...items, ...items]; // duplicate for continuous motion

            // reset button
            nextExerciseBtn.style.display = "none";
            belt.classList.remove("paused");

            // rebuild belt
            buildBelt();
        }

        function nextIteration() {
            if (currentIndex >= items.length) {
                finishExercise();
                return;
            }

            pauseBelt();
            highlightCurrent();
            updateHUD();

            feedback.style.color = "#333";
            feedback.innerText = `Current item: "${items[currentIndex]}". Choose Transmute or Skip.`;
        }

        function playerAction(transmute) {
            if (currentIndex >= items.length) {
                finishExercise();
                return;
            }

            pauseBelt();

            const current = items[currentIndex];

            // correct decisions
            if (current === "Lead" && transmute) {
                items[currentIndex] = "Gold";

                // update belt DOM for both duplicates
                domBeltItems[currentIndex].innerText = "Gold";
                domBeltItems[currentIndex].style.background = "#ffd700";

                domBeltItems[currentIndex + items.length].innerText = "Gold";
                domBeltItems[currentIndex + items.length].style.background = "#ffd700";

                feedback.style.color = "green";
                feedback.innerText = "‚ú® Correct! Lead became Gold.";
                currentIndex++;
            }
            else if (current !== "Lead" && !transmute) {
                feedback.style.color = "green";
                feedback.innerText = "‚è© Good! Non-lead item skipped.";
                currentIndex++;
            }
            else {
                feedback.style.color = "red";
                feedback.innerText = "‚ùå Wrong choice! Only Lead ‚Üí Transmute. Others ‚Üí Skip.";
                return;
            }

            updateInventoryText();
            updateHUD();
            highlightCurrent();

            if (currentIndex >= items.length) {
                setTimeout(finishExercise, 700);
            }
        }

        function finishExercise() {
            belt.classList.add("paused");

            feedback.style.color = "green";
            feedback.innerText = `üèÜ Exercise ${exerciseIndex + 1} complete!`;

            // show next exercise button if not last
            if (exerciseIndex < EXERCISES.length - 1) {
                nextExerciseBtn.style.display = "inline-block";
            } else {
                // last exercise complete => quest complete
                localStorage.setItem("q3Complete", "1");
                feedback.innerText = "üèÜ Level 3 Complete! Returning to map...";
                setTimeout(() => location.href = "python-level.html", 1500);
            }
        }

        function startNextExercise() {
            loadExercise(exerciseIndex + 1);
        }

        // INIT
        loadExercise(0);
    </script>
    <!-- Loading overlay -->
    <div id="loadingOverlay">
        <div class="loader-scroll">
            ‚ú® Loading Next Area...
            <div class="loader-bar">
                <div class="loader-fill"></div>
            </div>
        </div>
    </div>
    <script>
        // Fade-in on load
        document.addEventListener("DOMContentLoaded", () => {
            document.body.classList.add("page-fade");
            requestAnimationFrame(() => document.body.classList.add("show"));
        });

        // Navigate with animation
        function go(url) {
            const overlay = document.getElementById("loadingOverlay");
            overlay && overlay.classList.add("show");

            document.body.classList.add("page-exit");
            setTimeout(() => {
                location.href = url;
            }, 350);
        }

        // Intercept normal link clicks
        document.addEventListener("click", (e) => {
            const a = e.target.closest("a");
            if (!a) return;

            const href = a.getAttribute("href");
            if (!href || href.startsWith("#") || href.startsWith("javascript:")) return;

            e.preventDefault();
            go(href);
        });
    </script>

</body>

</html>